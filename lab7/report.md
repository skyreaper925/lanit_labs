# Отчёт по лабораторной работе 7

### Володин Максим

1. Командой `python3 -m venv venv` установил виртуальное окружение (выполнилась без ответа)

Затем я активировал виртуальное окружение командой `source venv/bin/activate`, что тоже выполнилась без ответа

Устанавливаю требуемые пакеты из файла с помощью `pip install -r vulnerable-app/requirements.txt`

2. Запускаю уязвимое приложение

```
user@RAM:/mnt/c/Users/user/PycharmProjects/lanit_labs/lab7$ docker-compose -f docker-compose.yml up -d --build # http://localhost:8080
WARN[0000] /mnt/c/Users/user/PycharmProjects/lanit_labs/lab7/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
[+] Building 136.2s (14/14) FINISHED                                                                                                                                                
 => [internal] load local bake definitions                                                                                                                                     0.0s
 => => reading from stdin 607B                                                                                                                                                 0.0s
 => [internal] load build definition from Dockerfile                                                                                                                           0.1s 
 => => transferring dockerfile: 463B                                                                                                                                           0.0s
 => [internal] load metadata for docker.io/library/python:3.11-slim                                                                                                            4.2s 
 => [auth] library/python:pull token for registry-1.docker.io                                                                                                                  0.0s
 => [internal] load .dockerignore                                                                                                                                              0.1s
 => => transferring context: 2B                                                                                                                                                0.0s 
 => [1/6] FROM docker.io/library/python:3.11-slim@sha256:158caf0e080e2cd74ef2879ed3c4e697792ee65251c8208b7afb56683c32ea6c                                                      0.1s 
 => => resolve docker.io/library/python:3.11-slim@sha256:158caf0e080e2cd74ef2879ed3c4e697792ee65251c8208b7afb56683c32ea6c                                                      0.1s
 => [internal] load build context                                                                                                                                              0.1s 
 => => transferring context: 4.12kB                                                                                                                                            0.0s 
 => CACHED [2/6] WORKDIR /app                                                                                                                                                  0.0s 
 => [3/6] RUN apt-get update &&     apt-get install -y --no-install-recommends         build-essential         libjpeg-dev zlib1g-dev         libxml2-dev libxslt1-dev &&     53.4s 
 => [4/6] COPY requirements.txt /app/requirements.txt                                                                                                                          0.3s 
 => [5/6] RUN pip install --no-cache-dir -r requirements.txt                                                                                                                  34.9s 
 => [6/6] COPY . /app                                                                                                                                                          0.2s 
 => exporting to image                                                                                                                                                        40.3s 
 => => exporting layers                                                                                                                                                       20.5s 
 => => exporting manifest sha256:5b794e288199ab5e6639dc963fc98fd4bfe9078877f124b3d10df38117105dc4                                                                              0.0s 
 => => exporting config sha256:05caf9f7a641229b118d50832478878c403006598b67cc4ba7cd13b2c7339ff3                                                                                0.0s 
 => => exporting attestation manifest sha256:eb242006a9822ab0dc43b0d6a894013c43c60f332279ebb0cf22c61ae443c204                                                                  0.1s 
 => => exporting manifest list sha256:14c128b62a0eb77b1d9d84bd0b6a8871b274d8cbbb7e2cad2ceac3c3e14b9d79                                                                         0.0s 
 => => naming to docker.io/library/lab7-vulnerable-app:latest                                                                                                                  0.0s 
 => => unpacking to docker.io/library/lab7-vulnerable-app:latest                                                                                                              19.6s 
 => resolving provenance for metadata file                                                                                                                                     0.3s 
[+] Running 3/3                                                                                                                                                                     
 ✔ lab7-vulnerable-app              Built                                                                                                                                      0.0s 
 ✔ Network lab7_default             Created                                                                                                                                    0.1s 
 ✔ Container lab7-vulnerable-app-1  Started  
```

3. Сначала устанавливаем недостающее
```
user@RAM:/mnt/c/Users/user/PycharmProjects/lanit_labs/lab7$ sudo snap install semgrep
[sudo] password for user: 
semgrep 1.56.0 from George-Andrei Iosif (iosifache) installed
```

Запускаем SAST Semgrep.
Команда выполнилась молча

4. Теперь запускаем SAST Checkov по Dockerfile и compose.
Сначала вновь устанавливаем библиотеку

После выполнения в консоли отражена сводка

```
passed: 50 
failed: 2 
skipped: 0
parsing_errors: 0 
resource_count: 1 
checkov_version: 3.2.459
```
5. Сначала переходим в другую папку и оттуда обновляем базу.
После этого устанавливаем новые зависимости (322 тысячи)

Ошибка была исправлена выгрузкой зависимостей из файла `pom.xml` в папку из сценария

В результате выполнения SCA-анализа был сформирован единый агрегированный отчёт

6. Запускаем `SCA CLI OWASP Dependency-Check` для уязвимого приложения.

Для `pom.xml` сканирование работает в обратную сторону: получает версии библиотек, которые затем сопоставлялись с CVE.
То есть файл был основным источник информации о зависимостях.

Для `app.py` сканирование не находило логических или программных уязвимостей.

#### Избыточная установка зависимостей

- Влияние
    - Увеличение размера образа и времени сборки
    - Усложнение аудита безопасности из-за большого числа пакетов
    - Риск наличия уязвимостей в неиспользуемых пакетах
- Сценарий атаки
    - Злоумышленник использует уязвимость в одном из автоматически установленных неиспользуемых пакетов для
      получения доступа к контейнеру или системе

#### Увеличенная поверхность атаки системы

- Влияние
    - Повышенный риск эксплуатации уязвимостей в неиспользуемых компонентах
    - Усложнение мониторинга и защиты системы
- Сценарий атаки
    - Атакующий сканирует систему на наличие уязвимых версий пакетов и эксплуатирует одну из них для повышения
      привилегий или выполнения произвольного кода

#### Использование устаревших пакетов

- Влияние
    - Система содержит известные уязвимости, для которых уже существуют обновления безопасности
    - Возможность эксплуатации публично известных CVE
- Сценарий атаки
    - Использование публичного эксплойта для уязвимой версии пакета с целью компрометации системы, например, через
      RCE (Remote Code Execution) или отказ в исполнении

#### Отсутствие контроля версий библиотек

- Влияние
    - Невоспроизводимость окружения, что усложняет отладку и развертывание
    - Риск несовместимости или скрытых уязвимостей при установке новых версий пакетов
- Сценарий атаки
    - При развёртывании в prod может быть установлена новая версия пакета с уязвимостью, которая эксплуатируется
      атакующим до выпуска исправления

7. Оценим риски ИБ и предложите меры для их снижения

#### Анализ файлов

Начнём с `docker-compose.yml`

- `vulnerable-web`
    - Конфигурация получается с хоста (есть риск, что она содержит уязвимости)
- `insecure-db`:
    - Публичный порт 5432 (PostgreSQL доступен снаружи)
    - Простой пароль для `root`
- `app`:
    - Секретный ключ в переменных среды (`APP_SECRET_KEY=hardcoded-in-env`)
    - Учётные данные БД в открытом виде
- везде
    - Отсутствие использования секретов (Docker Secrets / внешние vault)
    - Отсутствие ограничений ресурсов
    - Нет healthcheck
    - Нет явного указания сетей

Перейдём к `vulnerable-app.yml` ожидая гораздо больший набор уязвимостей

- `vulnerable-web`
    - `privileged: true` - полный доступ к хосту
    - `network_mode: host` - отсутствие сетевой изоляции
    - `user: "0:0"` - выполнение от root
    - `cap_add: - ALL` - все возможные capabilities
    - `security_opt: unconfined` - отключены AppArmor и seccomp
    - все секреты в среде (включая флаг!)
- `debug-shell`
    - Все те же привилегии, что и у первого сервиса
    - SSH сервер в контейнере с паролем `password`
    - Разрешение root-логина по паролю

#### Сценарии реализации рисков

Начнём с Confidentiality Risks (CR)

- Утечка секретов через переменные окружения
    - `docker inspect`, `docker exec env` раскрывают все секреты
    - Логи приложений могут содержать секреты
    - При компрометации одного сервиса становятся доступны сразу все секреты
- Доступ к данным БД
    - Публичный порт PostgreSQL + простой пароль = прямой доступ к данным
    - SQL инъекция через уязвимое приложение
- Доступ к хосту через Docker socket
    - Атакующий может создавать/удалять контейнеры и получать доступ к хосту

Продолжим уже по Data Loss Risks (DL)

- Отсутствует шифрование данных
    - Тома монтируются без шифрования
    - Бэкапы хранятся в открытом виде
- Упрощённое удаление данных
    - Через mounted Docker socket с помощью `docker volume rm`, `docker system prune`
    - Через root-монтирование с помощью `rm -rf /hostroot/*`
- Атака с последующим вымогательством (через root-доступ к хосту и последующим шифрованием всех данных)

В соответствии с этим меняем файлы, добавляя защищенные поля, порты и так далее

8. Анализируем и описываем уязвимости из файлов в результате сканирования безопасности (Trivy).
   Данные получены из `.odt` и `excel` файлов

#### Образ `postgres:16-alpine`

Он содержит критически важные компоненты инфраструктурного уровня.
Выявленные уязвимости сосредоточены в основном в стандартной библиотеке Go, используемой бинарным файлом `gosu`,
входящим в образ.

Всего выявлено 4 уязвимости уровня HIGH и 8 уязвимостей уровня MEDIUM

Уязвимости уровня HIGH

1. **CVE-2025-58183**  
   *Компонент:* `archive/tar` (Go)  
   *Описание:* Неконтролируемое выделение памяти при разборе GNU sparse map.  
   *Риск:* Возможен отказ в обслуживании при обработке специально сформированных tar-архивов.

2. **CVE-2025-58186**  
   *Компонент:* HTTP stack (Go)  
   *Описание:* Ограничение на размер HTTP-заголовков обходится за счёт большого числа cookies.  
   *Риск:* Переполнение памяти и деградация производительности сервиса.

3. **CVE-2025-58187**  
   *Компонент:* `crypto/x509`  
   *Описание:* Неэффективный алгоритм проверки name constraints в сертификатах.  
   *Риск:* Возможность атак типа отказ в обслуживании при обработке специально подготовленных сертификатов.

4. **CVE-2025-61729**  
   *Компонент:* `crypto/x509`  
   *Описание:* Чрезмерное потребление ресурсов при формировании строк ошибок.  
   *Риск:* Увеличение нагрузки на CPU при валидации TLS-сертификатов.

Уязвимости уровня MEDIUM

Уязвимости данной категории в основном связаны с:

- некорректной обработкой ASN.1, PEM и TLS структур;
- возможными panic-сценариями при обработке DSA-ключей;
- квадратичной сложностью алгоритмов парсинга сетевых данных.

Совокупный риск данных уязвимостей заключается в возможности локального или удалённого отказа в обслуживании.
Это особенно опасно в сценариях, где контейнер обрабатывает внешние TLS-соединения или пользовательский ввод.

Заметим, несмотря на то, что уязвимости не затрагивают непосредственно PostgreSQL, они присутствуют в служебных
бинарных зависимостях образа.
В средах с внешним сетевым доступом рекомендуется переход на образ с исправленными Go-библиотеками.

#### Образ `python:3.11-alpine`

В образе выявлена одна уязвимость среднего уровня, связанная с менеджером пакетов `pip`.

Уязвимость уровня MEDIUM

1. **CVE-2025-8869**  
   *Компонент:* `pip`  
   *Описание:* Отсутствие проверок при извлечении символических ссылок из пакетов.  
   *Риск:* Возможна запись файлов вне целевого каталога при установке вредоносного пакета.

Данная уязвимость актуальна в сценариях, где контейнер устанавливает зависимости во время сборки или выполнения.
Или использует непроверенные (сторонние) Python-пакеты.

#### Образ `docker/docker-bench-security:latest`

Тут и комментировать нечего: сборка 2018 года.
Две критические уязвимости, приводящие к дисбалансу стека.
Надо срочно обновиться до актуальной версии

9. Подготавливаю отчёт и делаю снимок с отправкой
10. Чистим кэш и контейнеры

`rm -rf ven` молча рекурсивно и без подтверждений удаляет каталог venv и всё его содержимое

`docker-compose -f demo-vulnerable-app.yml down` останавливает и удаляет использованные контейнеровозом ресурсы

`docker system prune -f` удаляет неиспользованные контейнеровозом ресурсы.
В ходе удаления вернул 158 Мбайт